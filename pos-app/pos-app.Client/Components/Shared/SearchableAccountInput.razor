@using Microsoft.AspNetCore.Components
@using pos_app.Client.Services
@using pos_app.Client.Models
@inject DataService DataService

<div class="@ColumnClass">
    <label for="@Id" class="form-label">@Label</label>
    <div class="position-relative account-search-container">
        <input type="text" 
               id="@Id"
               class="form-control pe-5 @(AdditionalClass ?? "")" 
               placeholder="@Placeholder" 
               value="@accountSearchTerm"
               @oninput="OnAccountSearchChanged"
               @onfocus="@(() => ShowAccountDropdown = true)"
               @onblur="HideAccountDropdown" />
        
        @if (!string.IsNullOrEmpty(accountSearchTerm))
        {
            <button type="button" 
                    class="btn btn-sm position-absolute top-50 end-0 translate-middle-y me-2 p-0 clear-search-btn" 
                    style="background: none; border: none; color: #6c757d; z-index: 10;"
                    @onclick="ClearSearch"
                    title="Clear search">
                <i class="fas fa-times"></i>
            </button>
        }
        
        @if (ShowAccountDropdown && filteredAccounts.Any())
        {
            <div class="position-absolute w-100 account-dropdown" 
                 style="top: 100%; z-index: 99999; background: white; border: 1px solid #dee2e6; border-top: none; left: 0; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
                @foreach (var account in filteredAccounts.Take(10))
                {
                    <div class="account-item" 
                         @onclick="() => SelectAccount(account)"
                         @onmouseover="@(() => hoveredAccount = account.AccCode)"
                         @onmouseout="@(() => hoveredAccount = null)">
                        <strong>@account.AccCode.Trim()</strong> - @account.AccName.Trim()
                    </div>
                }
            </div>
        }
    </div>
</div>

<style>
    .account-dropdown {
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 0 0 0.375rem 0.375rem;
    }
    
    .account-item {
        padding: 8px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .account-item:hover {
        background-color: #f8f9fa;
    }
    
    .account-item.selected {
        background-color: #007bff;
        color: white;
    }
    
    .clear-search-btn:hover {
        color: #dc3545 !important;
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    /* Ensure dropdown is not clipped by parent containers */
    .account-search-container {
        overflow: visible !important;
    }
    
    /* Additional dropdown styling for better visibility */
    .account-dropdown {
        z-index: 99999 !important;
        position: absolute !important;
        max-height: 300px !important;
        overflow-y: auto !important;
    }
</style>

@code {
    // Label text for the field
    [Parameter] public string Label { get; set; } = string.Empty;

    // Currently selected account code
    [Parameter] public string Value { get; set; } = string.Empty;

    // Event callback when account changes
    [Parameter] public EventCallback<string> ValueChanged { get; set; }

    // Placeholder text
    [Parameter] public string? Placeholder { get; set; }

    // HTML id attribute
    [Parameter] public string? Id { get; set; }

    // Additional CSS classes
    [Parameter] public string? AdditionalClass { get; set; }

    // Bootstrap column class
    [Parameter] public string ColumnClass { get; set; } = "col-md-3";

    private List<ClientCustomer> allAccounts = new();
    private List<ClientCustomer> filteredAccounts = new();
    private string accountSearchTerm = "";
    private string selectedAccountCode = "";
    private string selectedAccountDisplay = "";
    private string? hoveredAccount = null;
    private bool ShowAccountDropdown = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
        
        // If Value is already set, find and display the account
        if (!string.IsNullOrWhiteSpace(Value))
        {
            var account = allAccounts.FirstOrDefault(a => a.AccCode.Trim() == Value.Trim());
            if (account != null)
            {
                selectedAccountCode = account.AccCode;
                selectedAccountDisplay = $"{account.AccCode.Trim()} - {account.AccName.Trim()}";
                accountSearchTerm = selectedAccountDisplay;
            }
            else
            {
                accountSearchTerm = Value;
            }
        }
    }

    protected override void OnParametersSet()
    {
        // Update display when Value changes from outside
        if (!string.IsNullOrWhiteSpace(Value) && Value != selectedAccountCode)
        {
            var account = allAccounts.FirstOrDefault(a => a.AccCode.Trim() == Value.Trim());
            if (account != null)
            {
                selectedAccountCode = account.AccCode;
                selectedAccountDisplay = $"{account.AccCode.Trim()} - {account.AccName.Trim()}";
                accountSearchTerm = selectedAccountDisplay;
            }
            else
            {
                accountSearchTerm = Value;
                selectedAccountCode = Value;
            }
        }
        else if (string.IsNullOrWhiteSpace(Value) && !string.IsNullOrWhiteSpace(selectedAccountCode))
        {
            // Value was cleared
            accountSearchTerm = "";
            selectedAccountCode = "";
            selectedAccountDisplay = "";
        }
    }

    private async Task LoadAccounts()
    {
        try
        {
            allAccounts = await DataService.GetCustomersAsync();
            filteredAccounts = allAccounts.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading accounts: {ex.Message}");
        }
    }

    private void OnAccountSearchChanged(ChangeEventArgs e)
    {
        accountSearchTerm = e.Value?.ToString() ?? "";
        
        // Don't filter if we have a selected account and the search term matches it
        if (!string.IsNullOrEmpty(selectedAccountCode) && accountSearchTerm == selectedAccountDisplay)
        {
            filteredAccounts = allAccounts.ToList();
            ShowAccountDropdown = false;
        }
        else
        {
            if (string.IsNullOrEmpty(accountSearchTerm))
            {
                filteredAccounts = allAccounts.ToList();
            }
            else
            {
                var searchLower = accountSearchTerm.Trim().ToLower();
                filteredAccounts = allAccounts.Where(a => 
                    a.AccCode.Trim().ToLower().Contains(searchLower) ||
                    a.AccName.Trim().ToLower().Contains(searchLower)
                ).ToList();
            }
            
            ShowAccountDropdown = true;
        }
        
        StateHasChanged();
    }

    private void SelectAccount(ClientCustomer account)
    {
        selectedAccountCode = account.AccCode;
        selectedAccountDisplay = $"{account.AccCode.Trim()} - {account.AccName.Trim()}";
        accountSearchTerm = selectedAccountDisplay;
        ShowAccountDropdown = false;
        
        // Update the Value and notify parent
        Value = selectedAccountCode;
        ValueChanged.InvokeAsync(selectedAccountCode);
        
        StateHasChanged();
    }

    private async Task HideAccountDropdown()
    {
        await Task.Delay(200); // Small delay to allow click events
        ShowAccountDropdown = false;
        StateHasChanged();
    }

    private void ClearSearch()
    {
        accountSearchTerm = "";
        selectedAccountCode = "";
        selectedAccountDisplay = "";
        filteredAccounts = allAccounts.ToList();
        ShowAccountDropdown = false;
        
        // Clear the Value and notify parent
        Value = "";
        ValueChanged.InvokeAsync("");
        
        StateHasChanged();
    }
}

