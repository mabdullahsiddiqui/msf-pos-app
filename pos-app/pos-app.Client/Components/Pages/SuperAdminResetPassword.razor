@page "/superadmin/reset-password"
@rendermode InteractiveWebAssembly
@layout pos_app.Client.Components.Layout.SuperAdminLayout
@using pos_app.Client.Models
@using pos_app.Client.Services
@inject SuperAdminService SuperAdminService
@inject NavigationManager Navigation

<PageTitle>Reset Password - Super Admin</PageTitle>

<style>
    .password-requirements {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 20px;
        margin-top: 15px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .password-requirements h6 {
        color: #495057 !important;
        font-weight: 600;
        margin-bottom: 15px !important;
    }
    
    .password-requirements .d-flex {
        padding: 8px 0;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .password-requirements .d-flex:hover {
        background-color: rgba(255,255,255,0.5);
    }
    
    .form-control-lg {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .form-control-lg:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    
    .btn-lg {
        border-radius: 8px;
        padding: 12px 24px;
        font-weight: 600;
    }
    
    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .card-header {
        border-radius: 15px 15px 0 0 !important;
        background: linear-gradient(135deg, #28a745, #20c997) !important;
    }
    
    .progress {
        border-radius: 4px;
        background-color: #e9ecef;
    }
    
    .progress-bar {
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    .alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        border: 1px solid #b8daff;
        border-radius: 10px;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 1px solid #c3e6cb;
        border-radius: 10px;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border: 1px solid #f5c6cb;
        border-radius: 10px;
    }
    
    .form-label {
        color: #495057;
        font-weight: 600;
        margin-bottom: 8px;
    }
    
    .btn-outline-secondary {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-outline-secondary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>

<div class="card shadow">
    <div class="card-header bg-success text-white text-center">
        <h4 class="mb-0"><i class="fas fa-key"></i> Reset Password</h4>
    </div>
    <div class="card-body">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle"></i> @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show d-flex align-items-center" role="alert">
                <i class="fas fa-check-circle fa-2x me-3"></i>
                <div>
                    <h6 class="alert-heading mb-1">Success!</h6>
                    <p class="mb-0">@successMessage</p>
                </div>
            </div>
        }

        <!-- Email Display -->
        @if (!string.IsNullOrEmpty(resetPasswordRequest.Email))
        {
            <div class="alert alert-info mb-4">
                <i class="fas fa-envelope"></i> <strong>Resetting password for:</strong> @resetPasswordRequest.Email
            </div>
        }

        <EditForm Model="resetPasswordRequest" OnValidSubmit="ResetPassword" FormName="superAdminResetPasswordForm">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <!-- Password Requirements -->
            <div class="password-requirements my-3">
                <h6 class="text-muted mb-3">
                    <i class="fas fa-shield-alt me-1"></i> Password Requirements:
                </h6>
                <div class="row g-2">
                    <div class="col-12 col-sm-6">
                        <div class="d-flex align-items-center">
                            <i class="fas @(HasMinLength() ? "fa-check-circle text-success" : "fa-circle text-muted") me-2"></i>
                            <small class="@(HasMinLength() ? "text-success fw-bold" : "text-muted")">
                                At least 8 characters
                            </small>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <div class="d-flex align-items-center">
                            <i class="fas @(HasUppercase() ? "fa-check-circle text-success" : "fa-circle text-muted") me-2"></i>
                            <small class="@(HasUppercase() ? "text-success fw-bold" : "text-muted")">
                                Uppercase letter
                            </small>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <div class="d-flex align-items-center">
                            <i class="fas @(HasLowercase() ? "fa-check-circle text-success" : "fa-circle text-muted") me-2"></i>
                            <small class="@(HasLowercase() ? "text-success fw-bold" : "text-muted")">
                                Lowercase letter
                            </small>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <div class="d-flex align-items-center">
                            <i class="fas @(HasNumber() ? "fa-check-circle text-success" : "fa-circle text-muted") me-2"></i>
                            <small class="@(HasNumber() ? "text-success fw-bold" : "text-muted")">
                                Number
                            </small>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <div class="d-flex align-items-center">
                            <i class="fas @(HasSpecialChar() ? "fa-check-circle text-success" : "fa-circle text-muted") me-2"></i>
                            <small class="@(HasSpecialChar() ? "text-success fw-bold" : "text-muted")">
                                Special character
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <label for="newPassword" class="form-label fw-bold">
                    <i class="fas fa-lock me-1"></i> New Password
                </label>
                <InputText id="newPassword" type="password" class="form-control form-control-lg" 
                          @bind-Value="resetPasswordRequest.NewPassword"
                          @bind-Value:after="OnPasswordChanged"
                          placeholder="Enter your new password" />
                <ValidationMessage For="@(() => resetPasswordRequest.NewPassword)" />
            </div>

            <div class="mb-4">
                <label for="confirmPassword" class="form-label fw-bold">
                    <i class="fas fa-lock me-1"></i> Confirm New Password
                </label>
                <InputText id="confirmPassword" type="password" class="form-control form-control-lg" 
                          @bind-Value="resetPasswordRequest.ConfirmPassword"
                          @bind-Value:after="OnPasswordChanged"
                          placeholder="Confirm your new password" />
                <ValidationMessage For="@(() => resetPasswordRequest.ConfirmPassword)" />
                
                @if (!string.IsNullOrEmpty(resetPasswordRequest.ConfirmPassword) && !string.IsNullOrEmpty(resetPasswordRequest.NewPassword))
                {
                    <div class="mt-2">
                        @if (resetPasswordRequest.NewPassword == resetPasswordRequest.ConfirmPassword)
                        {
                            <small class="text-success">
                                <i class="fas fa-check-circle me-1"></i> Passwords match
                            </small>
                        }
                        else
                        {
                            <small class="text-danger">
                                <i class="fas fa-times-circle me-1"></i> Passwords do not match
                            </small>
                        }
                    </div>
                }
                                
                @if (!string.IsNullOrEmpty(resetPasswordRequest.NewPassword))
                {
                    <div class="mt-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted fw-bold">Password Strength:</small>
                            <small class="text-muted">@GetPasswordStrengthText()</small>
                        </div>
                        <div class="progress" style="height: 8px; border-radius: 4px;">
                            <div class="progress-bar @GetPasswordStrengthClass()" role="progressbar" 
                                 style="width: @GetPasswordStrengthPercentage()%; border-radius: 4px;"></div>
                        </div>
                    </div>
                }
            </div>

            <div class="d-grid gap-2 mb-4">
                <button type="submit" class="btn btn-success btn-lg position-relative" disabled="@isLoading">
                    @if (isLoading)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        <span>Resetting Password...</span>
                    }
                    else
                    {
                        <i class="fas fa-key me-2"></i>@("Reset Password")
                    }
                </button>
            </div>
        </EditForm>

        <div class="text-center">
            <a href="/superadmin/login" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Login
            </a>
        </div>
    </div>
    <div class="card-footer text-center">
        <small class="text-muted">
            <i class="fas fa-shield-alt"></i> Your password will be securely updated
        </small>
    </div>
</div>

@code {
    private ResetPasswordRequest resetPasswordRequest = new();
    
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if we have a reset token
        var token = await SuperAdminService.GetResetToken();
        if (string.IsNullOrEmpty(token))
        {
            errorMessage = "Invalid or expired reset link. Please request a new password reset.";
            return;
        }

        // Get the email from the forgot password flow
        var email = await SuperAdminService.GetForgotPasswordEmail();
        if (!string.IsNullOrEmpty(email))
        {
            resetPasswordRequest.Email = email;
        }
        
        // Set the reset token
        resetPasswordRequest.ResetToken = token;
        
        Console.WriteLine($"OnInitializedAsync - Email: {email}, Token: {token}");
    }

    private void OnPasswordChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task ResetPassword()
    {
        if (isLoading) return; // Prevent multiple submissions
        
        try
        {
            isLoading = true;
            errorMessage = string.Empty;
            successMessage = string.Empty;
            Console.WriteLine("SuperAdminResetPassword ResetPassword request: " + System.Text.Json.JsonSerializer.Serialize(resetPasswordRequest)); 
            var response = await SuperAdminService.ResetPasswordAsync(resetPasswordRequest);
            Console.WriteLine("SuperAdminResetPassword ResetPassword response: " + System.Text.Json.JsonSerializer.Serialize(response));
            if (response.Success)
            {
                successMessage = "Password reset successfully! You can now log in with your new password.";
                resetPasswordRequest = new(); // Clear form
                
                // Redirect to login after a short delay
                await Task.Delay(2000);
                Navigation.NavigateTo("/superadmin/login", forceLoad: true);
            }
            else
            {
                errorMessage = response.Message;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("SuperAdminResetPassword ResetPassword Exception: " + ex.Message);
            Console.WriteLine("SuperAdminResetPassword ResetPassword Exception StackTrace: " + ex.StackTrace);
            errorMessage = $"Error resetting password: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetPasswordStrengthClass()
    {
        var strength = GetPasswordStrength();
        if (strength < 25) return "bg-danger";
        if (strength < 50) return "bg-warning";
        if (strength < 75) return "bg-info";
        return "bg-success";
    }

    private int GetPasswordStrengthPercentage()
    {
        return GetPasswordStrength();
    }

    private string GetPasswordStrengthText()
    {
        var strength = GetPasswordStrength();
        if (strength < 25) return "Weak";
        if (strength < 50) return "Fair";
        if (strength < 75) return "Good";
        return "Strong";
    }

    private int GetPasswordStrength()
    {
        if (string.IsNullOrEmpty(resetPasswordRequest.NewPassword))
            return 0;

        var password = resetPasswordRequest.NewPassword;
        var score = 0;

        // Length check
        if (password.Length >= 8) score += 20;
        if (password.Length >= 12) score += 10;

        // Character variety checks
        if (password.Any(char.IsUpper)) score += 15;
        if (password.Any(char.IsLower)) score += 15;
        if (password.Any(char.IsDigit)) score += 15;
        if (password.Any(c => "!@#$%^&*()_+-=[]{}|;:,.<>?".Contains(c))) score += 15;

        // Additional complexity
        if (password.Length >= 16) score += 10;

        return Math.Min(score, 100);
    }

    // Password requirement check methods
    private bool HasMinLength()
    {
        return !string.IsNullOrEmpty(resetPasswordRequest.NewPassword) && resetPasswordRequest.NewPassword.Length >= 8;
    }

    private bool HasUppercase()
    {
        return !string.IsNullOrEmpty(resetPasswordRequest.NewPassword) && resetPasswordRequest.NewPassword.Any(char.IsUpper);
    }

    private bool HasLowercase()
    {
        return !string.IsNullOrEmpty(resetPasswordRequest.NewPassword) && resetPasswordRequest.NewPassword.Any(char.IsLower);
    }

    private bool HasNumber()
    {
        return !string.IsNullOrEmpty(resetPasswordRequest.NewPassword) && resetPasswordRequest.NewPassword.Any(char.IsDigit);
    }

    private bool HasSpecialChar()
    {
        return !string.IsNullOrEmpty(resetPasswordRequest.NewPassword) && 
               resetPasswordRequest.NewPassword.Any(c => "!@#$%^&*()_+-=[]{}|;:,.<>?".Contains(c));
    }
}
